{% extends 'base.html' %}
{% block title %}{{ topic.title }}{% endblock %}
{% block content %}
    <h1 class="my-4">{{ topic.title }}</h1>
    {% if topic.description %}
        <p>{{ topic.description|linebreaks }}</p>
    {% endif %}
    <p class="text-muted">
        Створено: {{ topic.created_at|date:"d.m.Y H:i" }} | 
        Автор: {{ topic.created_by.username }}
    </p>

    <h5 class="mt-4">Повідомлення</h5>
    {% if topic.posts.exists %}
        <div class="list-group mb-4">
            {% for post in topic.posts.all %}
                <div class="list-group-item">
                    <p>{{ post.content|linebreaks }}</p>
                    <small class="text-muted">
                        Автор: {{ post.created_by.username }} | 
                        Опубліковано: {{ post.created_at|date:"d.m.Y H:i" }}
                    </small>
                    {% if user.is_authenticated %}
                        {% if user.profile %}
                            {% if user == post.created_by or user.profile.role == 'moderator' or user.profile.role == 'admin' %}
                                <a href="{% url 'forum:post_edit' topic.pk post.pk %}" class="btn btn-sm btn-secondary mt-2">Редагувати</a>
                                <a href="{% url 'forum:post_delete' topic.pk post.pk %}" class="btn btn-sm btn-danger mt-2">Видалити</a>
                            {% endif %}
                        {% else %}
                            <p class="text-danger">Помилка: профіль користувача не знайдено</p>
                        {% endif %}
                    {% endif %}
                </div>
            {% endfor %}
        </div>
    {% else %}
        <p class="alert alert-info">У цій темі ще немає повідомлень.</p>
    {% endif %}

    {% if user.is_authenticated %}
        <h5 class="mt-4">Додати повідомлення</h5>
        <form method="post" action="{% url 'forum:post_create' topic.pk %}" class="col-md-8">
            {% csrf_token %}
            {{ form.non_field_errors }}
            <div class="mb-3">
                <label for="{{ form.content.id_for_label }}" class="form-label">Повідомлення</label>
                {{ form.content }}
                {{ form.content.errors }}
            </div>
            <button type="submit" class="btn btn-primary">Опублікувати</button>
        </form>
    {% else %}
        <div class="alert alert-warning">
            <p>Будь ласка, <a href="{% url 'login' %}">увійдіть</a>, щоб додати повідомлення.</p>
        </div>
    {% endif %}
    <a href="{% url 'forum:topic_list' %}" class="btn btn-secondary mt-3">Назад до списку тем</a>
{% endblock %}